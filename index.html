<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档预览</title>
    <meta name="description" content="文档预览工具">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff;
            overflow: hidden;
        }
        
        /* 极简模式 - 几乎全屏显示目标网站 */
        .minimal-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }
        
        .minimal-mode .top-bar {
            height: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .minimal-mode .content-frame {
            width: 100%;
            height: calc(100vh - 30px);
            border: none;
            display: block;
        }
        
        /* 标准模式 - 保留一些装饰 */
        .standard-mode {
            padding: 10px;
        }
        
        .standard-mode .header {
            background: #fff;
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
        }
        
        .standard-mode .header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .standard-mode .header p {
            font-size: 14px;
            color: #666;
        }
        
        .standard-mode .content-frame {
            width: 100%;
            height: calc(100vh - 120px);
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* 隐藏模式 - 完全隐藏中转页面元素 */
        .hidden-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }
        
        .hidden-mode .content-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: block;
        }
        
        .open-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .mode-switch {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        .mode-switch:hover {
            opacity: 1;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .standard-mode {
                padding: 5px;
            }
            
            .standard-mode .header {
                padding: 10px;
            }
            
            .standard-mode .content-frame {
                height: calc(100vh - 100px);
            }
        }
    </style>
</head>
<body>
    <!-- 模式切换按钮 -->
    <button class="mode-switch" onclick="switchMode()" title="切换显示模式">模式</button>
    
    <!-- 加载提示 -->
    <div id="loading" class="loading">正在加载...</div>
    
    <!-- 极简模式 -->
    <div id="minimal-container" class="minimal-mode" style="display: none;">
        <div class="top-bar">
            <span>文档预览</span>
            <button class="open-btn" onclick="openInBrowser()">浏览器打开</button>
        </div>
        <iframe id="minimal-frame" class="content-frame"></iframe>
    </div>
    
    <!-- 标准模式 -->
    <div id="standard-container" class="standard-mode" style="display: none;">
        <div class="header">
            <h1>📄 文档预览</h1>
            <p>安全预览文档内容</p>
        </div>
        <iframe id="standard-frame" class="content-frame"></iframe>
    </div>
    
    <!-- 隐藏模式 -->
    <div id="hidden-container" class="hidden-mode" style="display: none;">
        <iframe id="hidden-frame" class="content-frame"></iframe>
    </div>

    <script>
        // 显示模式：0=极简, 1=标准, 2=隐藏
        let currentMode = 0;
        
        // 获取目标URL
        const getTargetUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const target = urlParams.get('url') || urlParams.get('u') || urlParams.get('link');
            
            // 支持base64编码的URL
            if (target && target.includes('base64:')) {
                try {
                    return atob(target.replace('base64:', ''));
                } catch (e) {
                    console.error('Base64 decode failed:', e);
                }
            }
            
            return target ? decodeURIComponent(target) : 'https://example.com';
        };
        
        // 检测环境
        const isWeChat = () => /MicroMessenger/i.test(navigator.userAgent);
        const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 切换显示模式
        const switchMode = () => {
            currentMode = (currentMode + 1) % 3;
            showCurrentMode();
            loadContent();
        };
        
        // 显示当前模式
        const showCurrentMode = () => {
            const containers = ['minimal-container', 'standard-container', 'hidden-container'];
            
            containers.forEach((id, index) => {
                const element = document.getElementById(id);
                element.style.display = index === currentMode ? 'block' : 'none';
            });
            
            // 更新按钮文本
            const modeNames = ['极简', '标准', '隐藏'];
            document.querySelector('.mode-switch').textContent = modeNames[currentMode];
        };
        
        // 加载内容
        const loadContent = () => {
            const targetUrl = getTargetUrl();
            const frameIds = ['minimal-frame', 'standard-frame', 'hidden-frame'];
            const currentFrame = document.getElementById(frameIds[currentMode]);
            
            if (!currentFrame) return;
            
            // 移除所有sandbox限制，允许完整交互
            currentFrame.removeAttribute('sandbox');
            
            // 设置iframe属性以支持完整功能
            currentFrame.setAttribute('allowfullscreen', 'true');
            currentFrame.setAttribute('allow', 'camera; microphone; geolocation; payment; autoplay; encrypted-media');
            
            // 加载目标URL
            currentFrame.src = targetUrl;
            
            // 处理加载完成
            currentFrame.onload = () => {
                document.getElementById('loading').style.display = 'none';
                
                // 尝试隐藏滚动条（如果可能）
                try {
                    const frameDoc = currentFrame.contentDocument || currentFrame.contentWindow.document;
                    if (frameDoc) {
                        const style = frameDoc.createElement('style');
                        style.textContent = `
                            body { 
                                margin: 0 !important; 
                                padding: 0 !important;
                            }
                            ::-webkit-scrollbar { width: 0px; background: transparent; }
                        `;
                        frameDoc.head.appendChild(style);
                    }
                } catch (e) {
                    // 跨域限制，忽略错误
                    console.log('Cross-origin restrictions apply');
                }
            };
            
            // 处理加载错误
            currentFrame.onerror = () => {
                document.getElementById('loading').innerHTML = '加载失败，请尝试直接访问';
            };
        };
        
        // 在浏览器中打开
        const openInBrowser = () => {
            const targetUrl = getTargetUrl();
            
            if (isWeChat()) {
                // 微信环境提示
                alert('请点击右上角菜单，选择"在浏览器中打开"');
            } else {
                window.open(targetUrl, '_blank');
            }
        };
        
        // 自动选择最佳模式
        const autoSelectMode = () => {
            if (isWeChat()) {
                // 微信中使用极简模式
                currentMode = 0;
            } else if (isMobile()) {
                // 移动端使用隐藏模式
                currentMode = 2;
            } else {
                // 桌面端使用标准模式
                currentMode = 1;
            }
            
            // 检查URL参数中的模式设置
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');
            if (modeParam && ['0', '1', '2'].includes(modeParam)) {
                currentMode = parseInt(modeParam);
            }
        };
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            autoSelectMode();
            showCurrentMode();
            loadContent();
            
            // 5秒后自动隐藏模式切换按钮（在隐藏模式下）
            if (currentMode === 2) {
                setTimeout(() => {
                    document.querySelector('.mode-switch').style.display = 'none';
                }, 5000);
            }
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            // Ctrl+M 切换模式
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                switchMode();
            }
            
            // Ctrl+O 在浏览器中打开
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                openInBrowser();
            }
        });
    </script>
</body>
</html>
