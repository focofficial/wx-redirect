<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档预览</title>
    <meta name="description" content="文档预览工具">
    <!-- 尝试允许混合内容 - 注意：这不是所有浏览器都支持 -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff;
            overflow: hidden;
        }
        
        .container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }
        
        .top-bar {
            height: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            color: #6c757d;
            transition: opacity 0.3s;
        }
        
        .top-bar.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .content-frame {
            width: 100%;
            height: calc(100vh - 30px);
            border: none;
            display: block;
        }
        
        .content-frame.fullscreen {
            height: 100vh;
        }
        
        .open-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 9999;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            padding: 5px;
            display: flex;
            gap: 5px;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        .controls:hover {
            opacity: 1;
        }
        
        .control-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: #333;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .error-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .error-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .error-button {
            background: #5cb85c;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        #proxy-frame {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 控制按钮 -->
    <div class="controls">
        <button class="control-btn" onclick="toggleTopBar()" title="显示/隐藏顶栏">T</button>
        <button class="control-btn" onclick="openInBrowser()" title="在浏览器中打开">B</button>
        <button class="control-btn" onclick="refreshPage()" title="刷新页面">R</button>
    </div>
    
    <!-- 加载提示 -->
    <div id="loading" class="loading">正在加载...</div>
    
    <!-- 主容器 -->
    <div class="container">
        <div id="top-bar" class="top-bar">
            <span>文档预览</span>
            <button class="open-btn" onclick="openInBrowser()">浏览器打开</button>
        </div>
        <iframe id="content-frame" name="content-frame" class="content-frame"></iframe>
    </div>
    
    <!-- 混合内容错误备用显示 -->
    <div id="error-container" class="error-container" style="display: none;">
        <div class="error-icon">✓</div>
        <h2 class="error-title">正在载入页面</h2>
        <button class="error-button" onclick="openInBrowser()">立即进入</button>
    </div>
    
    <!-- 用于处理跳转的隐藏iframe -->
    <iframe id="proxy-frame" name="proxy-frame"></iframe>

    <script>
        // 获取目标URL
        const getTargetUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 支持新的参数格式: ?c=BASE64_ENCODED_URL
            const encodedUrl = urlParams.get('c');
            if (encodedUrl) {
                try {
                    return atob(encodedUrl);
                } catch (e) {
                    console.error('Base64 decode failed:', e);
                    return 'https://example.com';
                }
            }
            
            // 兼容旧的参数格式
            const target = urlParams.get('url') || urlParams.get('u') || urlParams.get('link');
            
            // 支持旧的base64编码格式
            if (target && target.startsWith('base64:')) {
                try {
                    return atob(target.replace('base64:', ''));
                } catch (e) {
                    console.error('Base64 decode failed:', e);
                }
            }
            
            return target ? decodeURIComponent(target) : 'https://example.com';
        };
        
        // 尝试将HTTP URL转换为HTTPS
        const tryHttpsUrl = (url) => {
            if (url.startsWith('http:')) {
                return url.replace('http:', 'https:');
            }
            return url;
        };
        
        // 检测环境
        const isWeChat = () => /MicroMessenger/i.test(navigator.userAgent);
        const isMobile = () => /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // 切换顶栏显示
        const toggleTopBar = () => {
            const topBar = document.getElementById('top-bar');
            const contentFrame = document.getElementById('content-frame');
            
            if (topBar.classList.contains('hidden')) {
                topBar.classList.remove('hidden');
                contentFrame.classList.remove('fullscreen');
            } else {
                topBar.classList.add('hidden');
                contentFrame.classList.add('fullscreen');
            }
        };
        
        // 在浏览器中打开
        const openInBrowser = () => {
            const targetUrl = getTargetUrl();
            
            if (isWeChat()) {
                // 微信环境提示
                alert('请点击右上角菜单，选择"在浏览器中打开"');
            } else {
                window.open(targetUrl, '_blank');
            }
        };
        
        // 刷新页面
        const refreshPage = () => {
            loadContent();
        };
        
        // 处理iframe内部链接点击
        const setupLinkInterception = () => {
            try {
                const frame = document.getElementById('content-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                
                if (!frameDoc) return; // 跨域限制
                
                // 拦截所有链接点击
                frameDoc.addEventListener('click', (e) => {
                    const link = e.target.closest('a');
                    if (!link) return;
                    
                    const href = link.getAttribute('href');
                    if (!href || href.startsWith('#')) return;
                    
                    // 阻止默认行为
                    e.preventDefault();
                    
                    // 在当前iframe中打开链接
                    frame.src = new URL(href, frame.src).href;
                });
            } catch (e) {
                console.log('Cannot access iframe content due to cross-origin restrictions');
            }
        };
        
        // 处理iframe内部表单提交
        const setupFormInterception = () => {
            try {
                const frame = document.getElementById('content-frame');
                const frameDoc = frame.contentDocument || frame.contentWindow.document;
                
                if (!frameDoc) return; // 跨域限制
                
                // 拦截所有表单提交
                frameDoc.addEventListener('submit', (e) => {
                    const form = e.target;
                    
                    // 修改表单target为当前iframe
                    form.target = 'content-frame';
                });
            } catch (e) {
                console.log('Cannot access iframe content due to cross-origin restrictions');
            }
        };
        
        // 显示备用界面
        const showFallbackUI = () => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-container').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
        };
        
        // 加载内容
        const loadContent = () => {
            let targetUrl = getTargetUrl();
            const frame = document.getElementById('content-frame');
            
            // 显示加载提示
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-container').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
            
            // 尝试将HTTP转换为HTTPS
            const httpsUrl = tryHttpsUrl(targetUrl);
            
            // 完全移除所有限制
            frame.removeAttribute('sandbox');
            
            // 设置允许的功能
            frame.setAttribute('allowfullscreen', 'true');
            frame.setAttribute('allow', 'camera; microphone; geolocation; payment; autoplay; encrypted-media; fullscreen');
            
            // 允许iframe内容控制父页面
            frame.setAttribute('allowtransparency', 'true');
            
            // 加载目标URL
            frame.src = httpsUrl;
            
            // 处理加载完成
            frame.onload = () => {
                document.getElementById('loading').style.display = 'none';
                
                // 尝试设置链接和表单拦截
                setTimeout(() => {
                    setupLinkInterception();
                    setupFormInterception();
                }, 1000);
                
                // 尝试注入辅助脚本
                injectHelperScript(frame);
            };
            
            // 处理加载错误
            frame.onerror = () => {
                showFallbackUI();
            };
            
            // 监听混合内容错误
            window.addEventListener('error', function(e) {
                if (e.message && (
                    e.message.includes('Mixed Content') || 
                    e.message.includes('insecure') ||
                    e.message.includes('blocked')
                )) {
                    console.log('Mixed content error detected');
                    showFallbackUI();
                }
            }, true);
            
            // 设置超时，如果加载时间过长则显示备用界面
            setTimeout(() => {
                try {
                    // 检查iframe是否成功加载
                    const iframeDoc = frame.contentDocument || frame.contentWindow.document;
                    if (!iframeDoc || !iframeDoc.body) {
                        showFallbackUI();
                    }
                } catch (e) {
                    // 如果出现跨域错误，可能是混合内容问题
                    if (targetUrl.startsWith('http:')) {
                        showFallbackUI();
                    }
                }
            }, 5000);
        };
        
        // 注入辅助脚本到iframe
        const injectHelperScript = (frame) => {
            try {
                const frameWindow = frame.contentWindow;
                const frameDoc = frameWindow.document;
                
                // 如果无法访问iframe内容，则退出
                if (!frameDoc) return;
                
                // 创建辅助脚本
                const script = frameDoc.createElement('script');
                script.textContent = `
                    // 重写window.open方法
                    const originalOpen = window.open;
                    window.open = function(url, target, features) {
                        // 如果是相对URL，转换为绝对URL
                        if (url && !url.match(/^(https?:|mailto:|tel:|javascript:|data:|#)/i)) {
                            url = new URL(url, window.location.href).href;
                        }
                        
                        // 如果是HTTP URL，尝试转换为HTTPS
                        if (url && url.startsWith('http:')) {
                            url = url.replace('http:', 'https:');
                        }
                        
                        // 在当前iframe中打开链接
                        if (url) {
                            window.location.href = url;
                            return window;
                        }
                        
                        // 否则使用原始方法
                        return originalOpen.apply(this, arguments);
                    };
                    
                    // 修复表单提交
                    document.addEventListener('submit', function(e) {
                        const form = e.target;
                        if (!form.target) {
                            form.target = '_self';
                        }
                        
                        // 如果表单action是HTTP，尝试转换为HTTPS
                        const action = form.getAttribute('action');
                        if (action && action.startsWith('http:')) {
                            form.setAttribute('action', action.replace('http:', 'https:'));
                        }
                    });
                    
                    // 修复location.href赋值
                    const originalDescriptor = Object.getOwnPropertyDescriptor(window.Location.prototype, 'href');
                    if (originalDescriptor && originalDescriptor.set) {
                        const originalSet = originalDescriptor.set;
                        Object.defineProperty(window.location, 'href', {
                            set: function(url) {
                                // 如果是相对URL，转换为绝对URL
                                if (url && !url.match(/^(https?:|mailto:|tel:|javascript:|data:|#)/i)) {
                                    url = new URL(url, window.location.href).href;
                                }
                                
                                // 如果是HTTP URL，尝试转换为HTTPS
                                if (url && url.startsWith('http:')) {
                                    url = url.replace('http:', 'https:');
                                }
                                
                                return originalSet.call(this, url);
                            },
                            get: originalDescriptor.get,
                            configurable: true
                        });
                    }
                    
                    // 通知父页面已加载
                    try {
                        window.parent.postMessage({ type: 'FRAME_LOADED' }, '*');
                    } catch (e) {}
                    
                    // 修复所有链接
                    document.addEventListener('DOMContentLoaded', function() {
                        const links = document.querySelectorAll('a[href^="http:"]');
                        links.forEach(link => {
                            link.href = link.href.replace('http:', 'https:');
                        });
                    });
                `;
                
                // 添加到iframe文档
                frameDoc.head.appendChild(script);
                
            } catch (e) {
                console.log('Cannot inject script due to cross-origin restrictions');
                
                // 跨域情况下，使用替代方案
                useFallbackMethod(frame);
            }
        };
        
        // 跨域情况下的替代方案
        const useFallbackMethod = (frame) => {
            // 监听消息
            window.addEventListener('message', (event) => {
                try {
                    const data = event.data;
                    
                    // 处理iframe内部的导航请求
                    if (data && data.type === 'NAVIGATE') {
                        let url = data.url;
                        // 如果是HTTP URL，尝试转换为HTTPS
                        if (url && url.startsWith('http:')) {
                            url = url.replace('http:', 'https:');
                        }
                        frame.src = url;
                    }
                } catch (e) {
                    console.error('Error processing message:', e);
                }
            });
        };
        
        // 自动隐藏顶栏（移动设备）
        const autoHideTopBar = () => {
            if (isMobile()) {
                setTimeout(() => {
                    toggleTopBar();
                }, 2000);
            }
        };
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadContent();
            autoHideTopBar();
            
            // 监听键盘快捷键
            document.addEventListener('keydown', (e) => {
                // Ctrl+T 切换顶栏
                if (e.ctrlKey && e.key === 't') {
                    e.preventDefault();
                    toggleTopBar();
                }
                
                // Ctrl+O 在浏览器中打开
                if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    openInBrowser();
                }
                
                // Ctrl+R 刷新页面
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshPage();
                }
            });
        });
    </script>
    
    <!-- 处理跨域通信的辅助脚本 -->
    <script>
        // 创建一个全局函数，用于处理iframe内部的导航
        window.handleFrameNavigation = (url) => {
            const frame = document.getElementById('content-frame');
            if (frame) {
                // 如果是HTTP URL，尝试转换为HTTPS
                if (url && url.startsWith('http:')) {
                    url = url.replace('http:', 'https:');
                }
                frame.src = url;
            }
        };
        
        // 监听来自iframe的消息
        window.addEventListener('message', (event) => {
            try {
                const data = event.data;
                
                if (data && data.type === 'FRAME_LOADED') {
                    // iframe已加载完成
                    document.getElementById('loading').style.display = 'none';
                }
                
                if (data && data.type === 'NAVIGATE') {
                    // iframe请求导航到新URL
                    handleFrameNavigation(data.url);
                }
                
                if (data && data.type === 'MIXED_CONTENT_ERROR') {
                    // 检测到混合内容错误
                    showFallbackUI();
                }
            } catch (e) {
                console.error('Error processing message:', e);
            }
        });
    </script>
</body>
</html>
